<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Node.js</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/materialize.min.css" media="screen,projection">
    <link rel="stylesheet" href="css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>
<div class="container">
    <h1>Добавление данных и создание коллекции</h1>
    <p>Установив бд, теперь мы можем добавить в нее данные. Все данные хранятся в бд в формате BSON, который близок к JSON, поэтому нам надо также вводить данные в этом формате. И хотя у нас, возможно, на данный момент нет ни одной коллекции, но при добавлении в нее данных она автоматически создается.</p>
    <p>Как ранее говорилось, имя коллекции - произвольный идентификатор, состоящий из не более чем 128 различных алфавитно-цифровых символов и знака подчеркивания.
        В то же время имя коллекции не должно начинаться с префикса <code>system.</code>, так как он зарезервирован для внутренних коллекций (например,
        коллекция <code>system.users</code> содержит всех пользователей базы данных). И также имя не должно содержать знака доллара - <code>$</code>.</p>
    <p>Для добавления в коллекцию могут использоваться три ее метода:</p>
    <ul class="browser-default">
        <li><p><span class="b">insertOne()</span>: добавляет один документ</p></li>
        <li><p><span class="b">insertMany()</span>: добавляет несколько документов</p></li>
        <li><p><span class="b">insert()</span>: может добавлять как один, так и несколько документов</p></li>
    </ul>
    <p>Итак, добавим один документ:</p>
    <pre class="code">
	db.users.insertOne({"name": "Tom", "age": 28, languages: ["english", "spanish"]})
</pre>
    <p>Документ представляет набор пар ключ-значение. В данном случае добавляемый документ имеет три ключа: name, age, languages, и каждому из них сопоставляет определенное значение. Например, ключу languages в качесте значения сопоставляется массив.</p>
    <p>Некоторые ограничения при использовании имен ключей:</p>
    <ul class="browser-default">
        <li><p>Символ <code>$</code> не может быть первым символом в имени ключа</p></li>
        <li><p>Имя ключа не может содержать символ точки <code>.</code></p></li>
        <li><p>Имя <code>_id</code> не рекомендуется использовать</p></li>
    </ul>
    <p>Стоит отметить, что названия ключей могут использоваться в кавычках, а могут и без кавычек.</p>
    <p>В случае удачного добавления на консоль будет выведен идентификатор добавленного документа.</p>
    <p>И чтобы убедиться, что документ в бд, мы его выводим функцией <code>find</code>.</p>
    <img src="images/mongo/day_4_1.png" alt="insertOne in mongodb">
    <p>Если надо добавить ряд документов, то мы можем воспользоваться методом <span class="b">insertMany()</span>:</p>
    <pre class="code">
db.users.insertMany([{"name": "Bob", "age": 26, languages: ["english", "frensh"]},
{"name": "Alice", "age": 31, languages:["german", "english"]}])
</pre>
    <p>После добавления консоль выводит идентификаторы добавленных документов:</p>
    <img src="images/mongo/day_4_2.png" alt="insertMany in mongodb">
    <p>И третий метод - <span class="b">insert()</span> демонстрирует более универсальный способ добавления документов. При его вызове в него также передается добавляемый документ:</p>
    <pre class="code">
	db.users.insert({"name": "Tom", "age": 28, languages: ["english", "spanish"]})
</pre>
    <p>После его вызова на консоль выводится количество добавленных записей:</p>
    <pre class="code">
	WriteResult({ "nInserted" : 1 })
</pre>

    <p>Возможно, не всем будет удобно вводить в одну строчку все пары ключей и свойств. Но интеллектуальный интерпретатор MongoDB на основе javascript
        позволяет также вводить и многострочные команды. Если выражение не закончено (с точки зрения языка JavaScript), и вы нажимаете Enter,
        то ввод следующей части выражения автоматически переносится на следующую строку:</p>
    <img src="pics/2.13.png" alt="Многострочный ввод в MongoDB">
    <h3>Переименование коллекции</h3>
    <p>В процессе работы, возможно, потребуется изменить название коллекции. Например, если при первом добавлении данных в ее названии была опечатка. И  чтобы не удалять и затем пересоздавать коллекцию, следует использовать функцию <code>renameCollection</code>:</p>
    <pre class="code">
db.users.renameCollection("новое_название")</pre>
    <p>И если переименование пройдет удачно, то консоль отобразит:</p>
    <pre class="code">
{"ok" : 1}
</pre>
    <h3>Явное создание коллекции</h3>
    <p>В предыдущем примере коллекция создавалась неявно автоматически при добавлении в нее первых данных. Но мы также можем создать ее явным образом,
        применив метод <span class="b">db.createCollection(name, options)</span>, где <code>name</code> - название коллекции, а <code>options</code> -
        необязательный объект с дополнительными настройками инициализации. Например:</p>
    <pre class="code">
db.createCollection("accounts")
{"ok" : 1}
</pre>
    <p>Таким образом, создается коллекция accounts.</p>
    <h3>Ограниченные коллекции</h3>
    <p>Когда мы отправляем запрос к бд на выборку, то MongoDB возвращает нам документы в том порядке, как правило, в котором они были добавлены. Однако такой порядок не
        всегда гарантируется, так как данные могут быть удалены, перемещены, изменены. Поэтому в MongoDB существует понятие <span class="bb">ограниченной коллекции</span>
        (capped collection). Подобная коллекция гарантирует, что документы будут располагаться в том же порядке, в котором они добавлялись в коллекцию.
        Ограниченные коллекции имеют фиксированный размер. И когда в коллекции уже нет места, наиболее старые документы удаляются, и в конец добавляются новые данные.</p>
    <p>В отличие от обычных коллекций ограниченные мы можем задать явным образом. Например, создадим ограниченную коллекцию с названием
        <code>profile</code> и зададим для нее размер в 9500 байт:</p>
    <pre class="code">
	db.createCollection("accounts")
{"ok" : 1}
</pre>
    <p>И после удачного создания коллекции консоль выведет:</p>
    <pre class="code">
{"ok":1}
</pre>
    <p>Также можно ограничить количество документов в коллекции, указав его в параметре <code>max</code>:</p>
    <pre class="code">
	db.createCollection("profile", {capped:true, size:9500, max: 150})
</pre>
    <p>Однако при таком способе создания коллекции следует учитывать, что если все место под коллекцию заполнено (например, выделенные нами 9500 байтов), а количество документов еще не достигло максимума, в данном случае 150, то в этом случае при добавлении нового документа самый старый документ будет удаляться, а на его место будет вставляться новый документ.</p>
    <p>При обновлении документов в таких коллекциях надо помнить, что документы не должны расти в размерах, иначе обновление не удастся произвести.</p>
    <p>Также нельзя удалять документы из подобных коллекций, можно только удалить всю коллекцию.</p>
    <h3>Подколлекции</h3>
    <p>Для упрощения организации данных в коллекциях мы можем использовать подколлекции. Например, данные по коллекции users надо разграничить на профили и учетные данные. И мы можем использовать создать коллекции <code>db.users.profiles</code> и <code>db.users.accounts</code>.
        При этом они не будут никак связаны с коллекцией <code>users</code>. То есть в итоге будут три разные коллекции, однако в плане логической организации хранения данных, возможно, для кого-то так будет проще.</p>

</div>


<!--Import jQuery before materialize.js-->
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="js/materialize.min.js"></script>
</body>
</html>